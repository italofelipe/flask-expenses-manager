name: Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev
      git_ref:
        description: "Git ref to deploy (branch/tag/sha). Empty = github.sha (manual)"
        required: false
        type: string
        default: ""

concurrency:
  group: deploy-${{ github.ref }}-${{ github.event_name }}-${{ inputs.env || 'dev' }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  deploy-dev:
    name: Deploy DEV
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || inputs.env == 'dev' }}
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required DEV deploy variables
        run: |
          [ -n "${AWS_REGION:-}" ] || { echo "Missing var AWS_REGION"; exit 1; }
          [ -n "${AWS_ROLE_ARN_DEV:-}" ] || { echo "Missing var AWS_ROLE_ARN_DEV"; exit 1; }
          [ -n "${AURAXIS_DEV_INSTANCE_ID:-}" ] || { echo "Missing var AURAXIS_DEV_INSTANCE_ID"; exit 1; }
          [ -n "${AURAXIS_PROD_INSTANCE_ID:-}" ] || { echo "Missing var AURAXIS_PROD_INSTANCE_ID"; exit 1; }
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          AWS_ROLE_ARN_DEV: ${{ vars.AWS_ROLE_ARN_DEV }}
          AURAXIS_DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          AURAXIS_PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy via SSM
        id: deploy_dev
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          INPUT_REF="${{ inputs.git_ref }}"
          REF="${INPUT_REF}"
          if [ "${{ github.event_name }}" = "push" ]; then
            REF="origin/master"
          elif [ -z "${REF}" ]; then
            REF="origin/${GITHUB_REF_NAME}"
          fi
          if [ -z "${REF}" ]; then
            echo "Unable to resolve deploy ref for DEV." >&2
            exit 1
          fi
          echo "Resolved DEV deploy ref:"
          echo "  event=${{ github.event_name }}"
          echo "  github_ref=${GITHUB_REF}"
          echo "  github_ref_name=${GITHUB_REF_NAME}"
          echo "  input_ref=${INPUT_REF:-<empty>}"
          echo "  resolved_ref=${REF}"
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            deploy --env dev --git-ref "${REF}"

      - name: REST + GraphQL smoke checks (DEV)
        env:
          DEV_BASE_URL: ${{ vars.AURAXIS_DEV_BASE_URL }}
        run: |
          BASE_URL="${DEV_BASE_URL:-http://dev.api.auraxis.com.br}"
          python scripts/http_smoke_check.py \
            --env-name dev \
            --base-url "${BASE_URL}" \
            --timeout 20

      - name: Auto-rollback DEV on deploy failure
        if: ${{ failure() }}
        continue-on-error: true
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            rollback --env dev

      - name: Deploy summary (DEV)
        if: ${{ always() }}
        run: |
          {
            echo "## Deploy DEV"
            echo ""
            echo "- branch/ref: \`${{ github.ref }}\`"
            echo "- event: \`${{ github.event_name }}\`"
            echo "- target env: \`dev\`"
            echo "- deploy step outcome: \`${{ steps.deploy_dev.outcome }}\`"
            echo "- smoke checks: \`enabled (REST + GraphQL)\`"
            echo "- rollback on failure: \`enabled\`"
            echo "- ref resolution:"
            echo "  - event: \`${{ github.event_name }}\`"
            echo "  - github ref: \`${{ github.ref }}\`"
            echo "  - github ref name: \`${{ github.ref_name }}\`"
            echo "  - input git_ref: \`${{ inputs.git_ref }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy-prod:
    name: Deploy PROD
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.env == 'prod' }}
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enforce PROD deploy from master branch
        run: |
          if [ "${GITHUB_REF}" != "refs/heads/master" ]; then
            echo "PROD deploy must run from master branch. Current ref: ${GITHUB_REF}" >&2
            exit 1
          fi

      - name: Validate required PROD deploy variables
        run: |
          [ -n "${AWS_REGION:-}" ] || { echo "Missing var AWS_REGION"; exit 1; }
          [ -n "${AWS_ROLE_ARN_PROD:-}" ] || { echo "Missing var AWS_ROLE_ARN_PROD"; exit 1; }
          [ -n "${AURAXIS_DEV_INSTANCE_ID:-}" ] || { echo "Missing var AURAXIS_DEV_INSTANCE_ID"; exit 1; }
          [ -n "${AURAXIS_PROD_INSTANCE_ID:-}" ] || { echo "Missing var AURAXIS_PROD_INSTANCE_ID"; exit 1; }
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          AWS_ROLE_ARN_PROD: ${{ vars.AWS_ROLE_ARN_PROD }}
          AURAXIS_DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          AURAXIS_PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy via SSM
        id: deploy_prod
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          INPUT_REF="${{ inputs.git_ref }}"
          REF="${INPUT_REF}"
          if [ -z "${REF}" ]; then
            REF="origin/master"
          fi
          if [ -z "${REF}" ]; then
            echo "Unable to resolve deploy ref for PROD." >&2
            exit 1
          fi
          echo "Resolved PROD deploy ref:"
          echo "  event=${{ github.event_name }}"
          echo "  github_ref=${GITHUB_REF}"
          echo "  github_ref_name=${GITHUB_REF_NAME}"
          echo "  input_ref=${INPUT_REF:-<empty>}"
          echo "  resolved_ref=${REF}"
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            deploy --env prod --git-ref "${REF}"

      - name: REST + GraphQL smoke checks (PROD)
        env:
          PROD_BASE_URL: ${{ vars.AURAXIS_PROD_BASE_URL }}
        run: |
          BASE_URL="${PROD_BASE_URL:-https://api.auraxis.com.br}"
          python scripts/http_smoke_check.py \
            --env-name prod \
            --base-url "${BASE_URL}" \
            --timeout 20

      - name: Auto-rollback PROD on deploy failure
        if: ${{ failure() }}
        continue-on-error: true
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            rollback --env prod

      - name: Deploy summary (PROD)
        if: ${{ always() }}
        run: |
          {
            echo "## Deploy PROD"
            echo ""
            echo "- branch/ref: \`${{ github.ref }}\`"
            echo "- input git_ref: \`${{ inputs.git_ref }}\`"
            echo "- event: \`${{ github.event_name }}\`"
            echo "- target env: \`prod\`"
            echo "- deploy step outcome: \`${{ steps.deploy_prod.outcome }}\`"
            echo "- smoke checks: \`enabled (REST + GraphQL)\`"
            echo "- rollback on failure: \`enabled\`"
            echo "- ref resolution:"
            echo "  - event: \`${{ github.event_name }}\`"
            echo "  - github ref: \`${{ github.ref }}\`"
            echo "  - github ref name: \`${{ github.ref_name }}\`"
            echo "  - input git_ref: \`${{ inputs.git_ref }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
