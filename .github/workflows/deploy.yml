name: Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev
      git_ref:
        description: "Git ref to deploy (branch/tag/sha). Empty = github.sha (manual)"
        required: false
        type: string
        default: ""

concurrency:
  group: deploy-${{ github.ref }}-${{ github.event_name }}-${{ inputs.env || 'dev' }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

jobs:
  deploy-dev:
    name: Deploy DEV
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || inputs.env == 'dev' }}
    environment: dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy via SSM
        id: deploy_dev
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          REF="${{ inputs.git_ref }}"
          if [ "${{ github.event_name }}" = "push" ]; then
            REF="origin/master"
          elif [ -z "${REF}" ]; then
            REF="${GITHUB_SHA}"
          fi
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            deploy --env dev --git-ref "${REF}"

      - name: Auto-rollback DEV on deploy failure
        if: ${{ failure() }}
        continue-on-error: true
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            rollback --env dev

      - name: Deploy summary (DEV)
        if: ${{ always() }}
        run: |
          {
            echo "## Deploy DEV"
            echo ""
            echo "- branch/ref: \`${{ github.ref }}\`"
            echo "- event: \`${{ github.event_name }}\`"
            echo "- target env: \`dev\`"
            echo "- deploy step outcome: \`${{ steps.deploy_dev.outcome }}\`"
            echo "- rollback on failure: \`enabled\`"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy-prod:
    name: Deploy PROD
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.env == 'prod' }}
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy via SSM
        id: deploy_prod
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          REF="${{ inputs.git_ref }}"
          if [ -z "${REF}" ]; then
            REF="${GITHUB_SHA}"
          fi
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            deploy --env prod --git-ref "${REF}"

      - name: Auto-rollback PROD on deploy failure
        if: ${{ failure() }}
        continue-on-error: true
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          DEV_INSTANCE_ID: ${{ vars.AURAXIS_DEV_INSTANCE_ID }}
          PROD_INSTANCE_ID: ${{ vars.AURAXIS_PROD_INSTANCE_ID }}
        run: |
          python scripts/aws_deploy_i6.py \
            --profile "" \
            --region "${AWS_REGION}" \
            --dev-instance-id "${DEV_INSTANCE_ID}" \
            --prod-instance-id "${PROD_INSTANCE_ID}" \
            rollback --env prod

      - name: Deploy summary (PROD)
        if: ${{ always() }}
        run: |
          {
            echo "## Deploy PROD"
            echo ""
            echo "- branch/ref: \`${{ github.ref }}\`"
            echo "- input git_ref: \`${{ inputs.git_ref }}\`"
            echo "- event: \`${{ github.event_name }}\`"
            echo "- target env: \`prod\`"
            echo "- deploy step outcome: \`${{ steps.deploy_prod.outcome }}\`"
            echo "- rollback on failure: \`enabled\`"
          } >> "$GITHUB_STEP_SUMMARY"
